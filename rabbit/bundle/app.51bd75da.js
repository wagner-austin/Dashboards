function N(e){let t=document.documentElement.clientWidth,n=document.documentElement.clientHeight;e.textContent="X";let r=e.getBoundingClientRect(),o=r.width,a=r.height;return e.textContent="",{width:Math.floor(t/o),height:Math.floor(n/a),charW:o,charH:a}}function he(e,t){return Array.from({length:t},()=>Array(e).fill(" "))}function we(e){return e.map(t=>t.join("")).join(`
`)}function E(e,t,n,r,o,a){for(let i=0;i<t.length;i++){let s=r+i,u=t[i];if(u!==void 0&&s>=0&&s<a)for(let c=0;c<u.length;c++){let l=n+c,d=u[c];if(l>=0&&l<o&&d!==void 0&&d!==" "){let f=e[s];f!==void 0&&(f[l]=d)}}}}var M=["                                                            ","      .                  .                .                 ","  .       .      +           .       .          .     +     ","     .        .      .   +       .        .  +      .    .  "," .      + .      .  .      . .      +  .      .   .     .   ","   . .     .  +    .   . .    .  .     . +     . .   +   .  "],ct=M[0].length;function ye(e,t,n,r){let o=ct;for(let a=0;a<M.length;a++){let i=r-M.length+a,s=M[a];if(i>=0&&i<r&&s!==void 0){let u=e[i];if(u===void 0)continue;for(let c=0;c<n;c++){let l=((c-Math.floor(t))%o+o)%o,d=s[l];d!==void 0&&d!==" "&&(u[c]=d)}}}}function O(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}function ut(e){return e==="day"||e==="night"||e==="dawn"||e==="dusk"}function lt(e){if(!O(e))return!1;let t=e.time;if(t!==void 0&&!ut(t))return!1;let n=e.location;return!(n!==void 0&&typeof n!="string")}function ft(e,t){if(!O(e))throw new Error(`audio.tracks[${String(t)}]: must be an object`);let n=e.id;if(typeof n!="string"||n.length===0)throw new Error(`audio.tracks[${String(t)}]: missing or invalid "id" field`);let r=e.path;if(typeof r!="string"||r.length===0)throw new Error(`audio.tracks[${String(t)}] "${n}": missing or invalid "path" field`);let o=e.volume;if(typeof o!="number"||o<0||o>1)throw new Error(`audio.tracks[${String(t)}] "${n}": "volume" must be a number between 0 and 1`);let a=e.loop;if(typeof a!="boolean")throw new Error(`audio.tracks[${String(t)}] "${n}": "loop" must be a boolean`);let i=e.tags;if(!lt(i))throw new Error(`audio.tracks[${String(t)}] "${n}": "tags" must be a valid TrackTags object`);let s={...i.time!==void 0?{time:i.time}:{},...i.location!==void 0?{location:i.location}:{}};return{id:n,path:r,volume:o,loop:a,tags:s}}function X(e){if(!O(e))throw new Error("audio: must be an object");let t=e.enabled;if(typeof t!="boolean")throw new Error('audio: "enabled" must be a boolean');let n=e.masterVolume;if(typeof n!="number"||n<0||n>1)throw new Error('audio: "masterVolume" must be a number between 0 and 1');let r=e.tracks;if(!Array.isArray(r))throw new Error('audio: "tracks" must be an array');let o=[],a=new Set;for(let i=0;i<r.length;i++){let s=ft(r[i],i);if(a.has(s.id))throw new Error(`audio.tracks[${String(i)}]: duplicate track id "${s.id}"`);a.add(s.id),o.push(s)}return{enabled:t,masterVolume:n,tracks:o}}function Y(e){let t=e[0];return t===void 0?null:t}function U(e){let t={currentTrackId:null,isPlaying:!1,volume:e.masterVolume,buffers:new Map,activeSource:null,fadingOutSources:[]};function n(f){return t.volume*f}async function r(f){let m=t.buffers.get(f.id);if(m!==void 0)return m;let p=await e.fetchFn(f.path);if(!p.ok)return null;let h=await p.arrayBuffer(),y=await e.context.decodeAudioData(h);return t.buffers.set(f.id,y),y}function o(f){f.gain.gain.linearRampToValueAtTime(0,1),t.fadingOutSources.push(f),setTimeout(()=>{f.source.stop(),t.fadingOutSources=t.fadingOutSources.filter(p=>p!==f)},1*1e3)}function a(f,m){let p=e.context.createBufferSource();p.buffer=f,p.loop=m.loop;let h=e.context.createGain();return h.gain.value=0,p.connect(h),h.connect(e.context.destination),{source:p,gain:h,track:m}}function i(f){let m=n(f.track.volume);f.gain.gain.linearRampToValueAtTime(m,0+1)}function s(f){t.currentTrackId=f.id,t.isPlaying=!0,t.activeSource!==null&&(o(t.activeSource),t.activeSource=null),r(f).then(m=>{if(m===null||t.currentTrackId!==f.id)return;let p=a(m,f);t.activeSource=p,p.source.start(),i(p),p.source.onended=()=>{t.activeSource===p&&(t.activeSource=null,t.isPlaying=!1)}}).catch(()=>{})}function u(){t.isPlaying=!1,t.activeSource!==null&&(t.activeSource.source.stop(),t.activeSource=null);for(let f of t.fadingOutSources)f.source.stop();t.fadingOutSources=[]}function c(){t.isPlaying=!0}function l(f){t.volume=Math.max(0,Math.min(1,f)),t.activeSource!==null&&(t.activeSource.gain.gain.value=n(t.activeSource.track.volume))}function d(){return{currentTrackId:t.currentTrackId,isPlaying:t.isPlaying,volume:t.volume}}return{play:s,pause:u,resume:c,setVolume:l,getState:d}}function dt(e,t){return e[t]}function pt(e){return"key"in e}function ge(e){let t=e.tracks.length;if(t<=1)return;let n=(e.currentIndex+1)%t,r=dt(e.tracks,n);r!==void 0&&(e.currentIndex=n,e.player.play(r))}function V(e,t){t("keydown",r=>{if(pt(r)&&(r.key==="n"||r.key==="N")){let o=e();o!==null&&ge(o)}})}function K(e,t){if(e===void 0||!e.enabled)return null;let n=Y(e.tracks);if(n===null)return null;let r=null,o=()=>{if(r!==null)return;let a=t.createContext(),i=U({context:a,fetchFn:t.fetchFn,masterVolume:e.masterVolume});r={context:a,player:i,tracks:e.tracks,currentIndex:0,cleanup:()=>{t.removeEventListenerFn("click",o),t.removeEventListenerFn("touchstart",o),t.removeEventListenerFn("touchend",o),t.removeEventListenerFn("keydown",o)}},a.state==="suspended"?a.resume().then(()=>{i.play(n)}).catch(()=>{i.play(n)}):i.play(n),t.removeEventListenerFn("click",o),t.removeEventListenerFn("touchstart",o),t.removeEventListenerFn("touchend",o),t.removeEventListenerFn("keydown",o)};return t.addEventListenerFn("click",o),t.addEventListenerFn("touchstart",o),t.addEventListenerFn("touchend",o),t.addEventListenerFn("keydown",o),{tracks:e.tracks,currentIndex:0,cleanup:()=>{t.removeEventListenerFn("click",o),t.removeEventListenerFn("touchstart",o),t.removeEventListenerFn("touchend",o),t.removeEventListenerFn("keydown",o)},getSystem:()=>r}}function q(){let e=window,t=e.AudioContext??e.webkitAudioContext;if(t===void 0)throw new Error("Web Audio API not supported");return new t}function z(){return{createContext:q,fetchFn:e=>fetch(e),addEventListenerFn:(e,t)=>{document.addEventListener(e,t)},removeEventListenerFn:(e,t)=>{document.removeEventListener(e,t)}}}function v(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}function xe(e){if(!Array.isArray(e))return!1;for(let t of e)if(typeof t!="string")return!1;return!0}function ke(e){return v(e)?typeof e.fps=="number"&&typeof e.jumpSpeed=="number"&&typeof e.scrollSpeed=="number":!1}function mt(e,t){if(!v(e))throw new Error(`Invalid sprite module at ${t}: not an object`);let n=e.frames;if(!xe(n))throw new Error(`Invalid sprite module at ${t}: frames must be string array`);return{frames:n}}function Te(e){if(e!==void 0)return X(e)}function ht(e){if(!v(e))throw new Error("Invalid config: not an object");let t=e.sprites;if(!v(t))throw new Error("Invalid config: missing sprites object");let n=e.layers;if(!Array.isArray(n))throw new Error("Invalid config: missing layers array");let r=e.settings;if(!ke(r))throw new Error("Invalid config: invalid settings object");let o=Te(e.audio),a=e.autoLayers,i={sprites:t,layers:n,settings:r},s=o!==void 0,u=a!==void 0;return s&&u?{...i,audio:o,autoLayers:a}:s?{...i,audio:o}:u?{...i,autoLayers:a}:i}function x(e,t){let n=null;return{start(){n===null&&(n=setInterval(t,e))},stop(){n!==null&&(clearInterval(n),n=null)},isRunning(){return n!==null}}}var G={isRecord:v,isStringArray:xe,isSettings:ke,validateSpriteModule:mt,validateOptionalAudio:Te,validateConfig:ht};function L(e){return e.animation.kind==="hop"}function T(e){return e.animation.kind==="jump"}function Ae(e){return e.animation.kind==="walk"}function Le(){return{facingRight:!1,animation:{kind:"idle",frameIdx:0}}}function Se(e,t,n,r){let o=x(n.walk,()=>{if(e.animation.kind!=="walk")return;let c=e.facingRight?t.walkRight:t.walkLeft;e.animation.frameIdx=(e.animation.frameIdx+1)%c.length}),a=x(n.idle,()=>{if(e.animation.kind!=="idle")return;let c=e.facingRight?t.idleRight:t.idleLeft;e.animation.frameIdx=(e.animation.frameIdx+1)%c.length}),i=x(n.jump,()=>{if(e.animation.kind!=="jump")return;let c=e.facingRight?t.jumpRight:t.jumpLeft;e.animation.frameIdx++,e.animation.frameIdx>=c.length&&(i.stop(),r()?(e.animation={kind:"walk",frameIdx:0},o.start()):(e.animation={kind:"idle",frameIdx:0},a.start()))}),s=x(n.transition,()=>{if(e.animation.kind!=="transition")return;let c=e.animation;if(c.type==="walk_to_idle"){let l=e.facingRight?t.walkToIdleRight:t.walkToIdleLeft;c.frameIdx++,c.frameIdx>=l.length&&(s.stop(),e.animation={kind:"idle",frameIdx:0},a.start())}else if(c.type==="idle_to_walk")c.frameIdx--,c.frameIdx<0&&(s.stop(),c.pendingAction==="jump"?(e.animation={kind:"jump",frameIdx:0},i.start()):c.pendingAction==="hop_away"?(e.animation={kind:"transition",type:"walk_to_turn_away",frameIdx:0,pendingAction:null,returnTo:"idle"},s.start()):c.pendingAction==="hop_toward"?(e.animation={kind:"transition",type:"walk_to_turn_toward",frameIdx:0,pendingAction:null,returnTo:"idle"},s.start()):(e.animation={kind:"walk",frameIdx:0},o.start()));else if(c.type==="walk_to_turn_away"){c.frameIdx++;let l=e.facingRight?t.walkToTurnAwayRight:t.walkToTurnAwayLeft;c.frameIdx>=l.length&&(s.stop(),e.animation={kind:"hop",direction:"away",frameIdx:0},u.start())}else{c.frameIdx++;let l=e.facingRight?t.walkToTurnTowardRight:t.walkToTurnTowardLeft;c.frameIdx>=l.length&&(s.stop(),e.animation={kind:"hop",direction:"toward",frameIdx:0},u.start())}}),u=x(n.hop,()=>{if(e.animation.kind!=="hop")return;let c=e.animation.direction==="away"?t.hopAway:t.hopToward;e.animation.frameIdx=(e.animation.frameIdx+1)%c.length});return{walk:o,idle:a,jump:i,transition:s,hop:u}}function _e(e,t){let n=e.animation,r,o;switch(n.kind){case"idle":r=e.facingRight?t.idleRight:t.idleLeft,o=n.frameIdx%r.length;break;case"walk":r=e.facingRight?t.walkRight:t.walkLeft,o=n.frameIdx;break;case"jump":r=e.facingRight?t.jumpRight:t.jumpLeft,o=n.frameIdx;break;case"hop":r=n.direction==="away"?t.hopAway:t.hopToward,o=n.frameIdx%r.length;break;case"transition":n.type==="idle_to_walk"||n.type==="walk_to_idle"?r=e.facingRight?t.walkToIdleRight:t.walkToIdleLeft:n.type==="walk_to_turn_away"?r=e.facingRight?t.walkToTurnAwayRight:t.walkToTurnAwayLeft:r=e.facingRight?t.walkToTurnTowardRight:t.walkToTurnTowardLeft,o=Math.max(0,Math.min(n.frameIdx,r.length-1));break}let a=r[o];return{lines:a!==void 0?a.split(`
`):[],frameIdx:o}}function J(e,t,n){return{layers:e,camera:t,depthBounds:n}}function Q(e,t){return{entity:e,effectiveZ:t}}var b={static:{parallax:0,wrapX:!1,wrapZ:!1},background:{parallax:.3,wrapX:!1,wrapZ:!1},midground:{parallax:1,wrapX:!0,wrapZ:!0},foreground:{parallax:1,wrapX:!0,wrapZ:!1}};function Ie(){return{focalLength:50,horizonY:.12,nearZ:40,farZ:200,groundY:.85,parallaxStrength:.5,wrapIterations:2}}var ee=55,A=800;function Ee(e,t,n){let r=n.farZ-n.nearZ,o=e-n.farZ,a=o+r;return{minZ:o,maxZ:a,range:r}}function ve(){return{x:0,z:ee}}function be(e,t,n,r,o,a){let i=t-n.z;if(i<a.nearZ||i>a.farZ)return{x:0,y:0,scale:0,visible:!1};let s=e-n.x,u=r/2,c=o*a.horizonY,l=o*a.groundY,d=a.focalLength/i,f=a.farZ-a.nearZ,p=(1-(i-a.nearZ)/f)*a.parallaxStrength,h=u+s*p,w=50/i,C=l-c,$=c+C*w;return{x:Math.round(h),y:Math.round($),scale:Math.min(Math.max(d,0),1.5),visible:!0}}function Re(e,t){if(t<=1)return 0;let n=Math.min(Math.max(e,0),1);return Math.round(n*(t-1))}function De(e,t,n){if(e>=t&&e<n)return e;let r=n-t,a=((e-t)%r+r)%r;return t+a}function wt(e){let t=e;return()=>(t=t*1664525+1013904223>>>0,t/4294967296)}function yt(e,t){if(e.length===0)throw new Error("autoLayers: sprites array is empty");let n=t%e.length,r=e[n];if(r===void 0)throw new Error(`autoLayers: sprite index ${String(n)} out of bounds`);return r}function gt(e){let t=[],n=wt(e.seed??12345),r=e.maxLayer-e.minLayer+1,o=e.sprites,a=e.treesPerLayer??2;for(let i=0;i<r;i++){let s=e.minLayer+i,u=yt(o,i),c=[];for(let l=0;l<a;l++){let d=l/a*A-A/2,f=(n()-.5)*200;c.push(Math.round(d+f))}t.push({name:`auto-trees-${String(s)}`,sprites:[u],layer:s,positions:c})}return t}function Fe(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}function Ce(e){if(!Array.isArray(e))return!1;for(let t of e)if(typeof t!="string")return!1;return!0}function xt(e){if(!Array.isArray(e))return!1;for(let t of e)if(typeof t!="number")return!1;return!0}function kt(e){return e==="static"||e==="tile"||e==="sprites"}function Tt(e){return e==="static"||e==="background"||e==="midground"||e==="foreground"}function At(e){return e.behavior!==void 0?b[e.behavior]:e.type==="static"?b.static:e.tile===!0?b.foreground:b.midground}function Lt(e){if(!Fe(e))throw new Error("autoLayers: must be an object");let t=e.sprites;if(!Ce(t)||t.length===0)throw new Error("autoLayers.sprites: must be non-empty string array");let n=e.minLayer;if(typeof n!="number"||!Number.isInteger(n))throw new Error("autoLayers.minLayer: must be an integer");let r=e.maxLayer;if(typeof r!="number"||!Number.isInteger(r))throw new Error("autoLayers.maxLayer: must be an integer");if(n>r)throw new Error("autoLayers: minLayer must be <= maxLayer");let o=e.treesPerLayer;if(o!==void 0&&(typeof o!="number"||!Number.isInteger(o)||o<1))throw new Error("autoLayers.treesPerLayer: must be a positive integer");let a=e.seed;if(a!==void 0&&(typeof a!="number"||!Number.isInteger(a)))throw new Error("autoLayers.seed: must be an integer");return{sprites:t,minLayer:n,maxLayer:r,...o!==void 0?{treesPerLayer:o}:{},...a!==void 0?{seed:a}:{}}}function St(e,t){if(!Fe(e))throw new Error(`layers[${String(t)}]: must be an object`);let n=e.name;if(typeof n!="string"||n.length===0)throw new Error(`layers[${String(t)}]: missing or invalid "name" field`);let r=e.type;if(r!==void 0&&!kt(r))throw new Error(`layers[${String(t)}] "${n}": invalid "type" (must be static|tile|sprites)`);let o=e.sprites;if(o!==void 0&&!Ce(o))throw new Error(`layers[${String(t)}] "${n}": "sprites" must be string array`);let a=e.positions;if(a!==void 0&&!xt(a))throw new Error(`layers[${String(t)}] "${n}": "positions" must be number array`);let i=e.layer;if(i!==void 0&&typeof i!="number")throw new Error(`layers[${String(t)}] "${n}": "layer" must be a number`);let s=e.tile;if(s!==void 0&&typeof s!="boolean")throw new Error(`layers[${String(t)}] "${n}": "tile" must be a boolean`);let u=e.behavior;if(u!==void 0&&!Tt(u))throw new Error(`layers[${String(t)}] "${n}": "behavior" must be static|background|midground|foreground`);return{name:n,...r!==void 0?{type:r}:{},...o!==void 0?{sprites:o}:{},...a!==void 0?{positions:a}:{},...i!==void 0?{layer:i}:{},...s!==void 0?{tile:s}:{},...u!==void 0?{behavior:u}:{}}}var _t=10;function It(e,t){return{name:e.name,type:e.type??"sprites",layer:e.layer??_t,spriteNames:e.sprites??[],positions:e.positions??[],zIndex:t,tile:e.tile??!1,behavior:At(e)}}function te(e,t){let n=[];if(t!==void 0){let o=Lt(t),a=gt(o);n.push(...a)}if(Array.isArray(e)){let o=e;for(let a of o)n.push(a)}return[...Me(n)].sort((o,a)=>a.layer-o.layer)}function Me(e){if(!Array.isArray(e))throw new Error("layers: must be an array");let t=[],n=new Set;for(let r=0;r<e.length;r++){let o=St(e[r],r);if(n.has(o.name))throw new Error(`layers[${String(r)}]: duplicate layer name "${o.name}"`);n.add(o.name),t.push(It(o,r))}return t}function H(e,t,n,r,o){return{spriteName:e,sizes:t,sizeIdx:o,frameIdx:0,worldX:n,worldZ:r}}function ne(e){let t=e.sizes[e.sizeIdx];if(t===void 0)return null;let n=t.frames[e.frameIdx];return n===void 0?null:{lines:n.split(`
`),width:t.width}}function Et(e){let t=e.sizes[e.sizeIdx];t!==void 0&&(e.frameIdx=(e.frameIdx+1)%t.frames.length)}function vt(e){for(let t of e.layers)for(let n of t.entities)Et(n)}function ze(e){return()=>{vt(e)}}function bt(e,t){let n=e.worldX-t,r=A/2;n<-r?e.worldX+=A:n>r&&(e.worldX-=A)}function Rt(e,t){let n=t.farZ-t.nearZ,r=[];for(let o=t.wrapIterations;o>=-t.wrapIterations;o--)r.push(e+o*n);return r}function He(e,t){let n=[];for(let r of e){let o=Rt(r.worldZ,t);for(let a of o)n.push(Q(r,a))}return n}function je(e){let t=[];for(let n of e)t.push(Q(n,n.worldZ));return t}function We(e,t){return t.effectiveZ-e.effectiveZ}function Pe(e,t,n,r,o,a){Ft(e,t.entity,t.effectiveZ,n,r,o,a)}function Dt(e,t,n,r,o,a,i){let s=i?He(t,a):je(t);s.sort(We);for(let u of s)Pe(e,u,n,r,o,a)}function Ft(e,t,n,r,o,a,i){let s=be(t.worldX,n,r,o,a,i);if(!s.visible)return;t.sizeIdx=Re(s.scale,t.sizes.length);let u=ne(t);if(u===null)return;let c=s.x-Math.floor(u.width/2),l=s.y-u.lines.length;E(e,u.lines,c,l,o,a)}function Ct(e,t,n){let r=e.config.behavior.wrapX&&!e.config.tile,o=e.config.behavior.wrapZ;if(r)for(let a of e.entities)bt(a,t.x);return o?He(e.entities,n):je(e.entities)}function re(e,t,n,r,o){let a=[];for(let i of t.layers)if(!i.config.name.includes("front")){let s=Ct(i,t.camera,o);a.push(...s)}a.sort(We);for(let i of a)Pe(e,i,t.camera,n,r,o)}function Mt(e,t,n,r,o){let a=ne(t);if(a===null)return;let i=a.width,s=o-a.lines.length,c=-(Math.floor(n.x)%i);for(let l=c-i;l<r+i;l+=i)E(e,a.lines,l,s,r,o)}function zt(e,t,n,r,o,a){let i=t.config.tile,s=t.entities[0];i&&s!==void 0?Mt(e,s,n,r,o):Dt(e,t.entities,n,r,o,a,t.config.behavior.wrapZ)}function oe(e,t,n,r,o){for(let a of t.layers)a.config.name.includes("front")&&zt(e,a,t.camera,n,r,o)}function Ht(e,t,n,r,o){let a=_e(t,n),i=Math.floor(r/2)-20,s=o-a.lines.length-2;E(e,a.lines,i,s,r,o)}function ie(e,t,n,r,o){let a=e.lastTime>0?(r-e.lastTime)/1e3:0,{width:i,height:s}=e.viewport,u=he(i,s),c=e.projectionConfig;if(re(u,e.sceneState,i,s,c),ye(u,-Math.floor(e.sceneState.camera.x),i,s),Ht(u,e.bunnyState,t,i,s),oe(u,e.sceneState,i,s,c),n.textContent=we(u),Ae(e.bunnyState)){let l=o*a,d=e.bunnyState.facingRight?1:-1;e.sceneState.camera={...e.sceneState.camera,x:e.sceneState.camera.x+l*d}}return{lastTime:r}}function j(e){return e.animation.kind==="transition"&&e.animation.pendingAction==="jump"}function W(e,t,n){let r=e.animation;if(r.kind==="idle"){n.idle.stop();let o=e.facingRight?t.walkToIdleRight:t.walkToIdleLeft;e.animation={kind:"transition",type:"idle_to_walk",frameIdx:o.length-1,pendingAction:"jump",returnTo:"idle"},n.transition.start()}else r.kind==="walk"?(n.walk.stop(),e.animation={kind:"jump",frameIdx:0},n.jump.start()):r.kind==="transition"&&(n.transition.stop(),e.animation={kind:"jump",frameIdx:0},n.jump.start())}function ae(e,t,n,r){let o=e.animation;if(o.kind==="idle"){e.facingRight=r,n.idle.stop();let a=r?t.walkToIdleRight:t.walkToIdleLeft;e.animation={kind:"transition",type:"idle_to_walk",frameIdx:a.length-1,pendingAction:"walk",returnTo:"idle"},n.transition.start()}else o.kind==="transition"?(e.facingRight=r,n.transition.stop(),e.animation={kind:"walk",frameIdx:0},n.walk.start()):o.kind==="walk"&&(e.facingRight=r,e.animation.frameIdx=0)}function Be(e,t){let n=e.animation;n.kind==="walk"?(t.walk.stop(),e.animation={kind:"transition",type:"walk_to_idle",frameIdx:0,pendingAction:null,returnTo:"idle"},t.transition.start()):n.kind==="transition"&&n.type==="idle_to_walk"&&(t.transition.stop(),e.animation={kind:"idle",frameIdx:0},t.idle.start())}function P(e,t,n){if(T(e)||L(e))return;let r=e.animation,o=n==="away"?"hop_away":"hop_toward",a=n==="away"?"walk_to_turn_away":"walk_to_turn_toward";switch(r.kind){case"idle":t.idle.stop(),e.animation={kind:"transition",type:a,frameIdx:0,pendingAction:null,returnTo:"idle"},t.transition.start();break;case"walk":t.walk.stop(),e.animation={kind:"transition",type:a,frameIdx:0,pendingAction:null,returnTo:"walk"},t.transition.start();break;case"transition":e.animation={...r,pendingAction:o};break}}function B(e,t,n){let r=e.animation;if(r.kind==="transition"){if(r.type==="walk_to_turn_away"||r.type==="walk_to_turn_toward"){t.transition.stop(),n()?(e.animation={kind:"walk",frameIdx:0},t.walk.start()):(e.animation={kind:"idle",frameIdx:0},t.idle.start());return}r.type==="idle_to_walk"&&(r.pendingAction==="hop_away"||r.pendingAction==="hop_toward")&&(e.animation={kind:"transition",type:"idle_to_walk",frameIdx:r.frameIdx,pendingAction:null,returnTo:r.returnTo});return}r.kind==="hop"&&(t.hop.stop(),n()?(e.animation={kind:"walk",frameIdx:0},t.walk.start()):(e.animation={kind:"idle",frameIdx:0},t.idle.start()))}function R(e,t,n,r,o,a,i){let s=()=>o.horizontalHeld!==null,u=t!==null,c=r!==null;if(!u&&c){let d=r==="up"?"away":"toward";P(o.bunny,i,d)}else u&&!c?B(o.bunny,i,s):t==="up"&&r==="down"?(B(o.bunny,i,s),P(o.bunny,i,"toward")):t==="down"&&r==="up"&&(B(o.bunny,i,s),P(o.bunny,i,"away"));L(o.bunny)||T(o.bunny)||r!==null?n==="left"?o.bunny.facingRight=!1:n==="right"&&(o.bunny.facingRight=!0):n==="left"&&e!=="left"?ae(o.bunny,a,i,!1):n==="right"&&e!=="right"?ae(o.bunny,a,i,!0):n===null&&e!==null&&Be(o.bunny,i)}function $e(e,t,n){document.addEventListener("keydown",r=>{if(r.repeat)return;let o=r.key.toLowerCase(),a=r.key==="ArrowLeft"||o==="a",i=r.key==="ArrowRight"||o==="d",s=r.key==="ArrowUp"||o==="w",u=r.key==="ArrowDown"||o==="s",c=e.horizontalHeld,l=e.verticalHeld;if(a)e.horizontalHeld="left";else if(i)e.horizontalHeld="right";else if(s)e.verticalHeld="up";else if(u)e.verticalHeld="down";else if(r.key===" "&&!T(e.bunny)&&!j(e.bunny)){W(e.bunny,t,n),r.preventDefault();return}else if(o==="r"){e.camera={x:0,z:ee};return}else return;R(c,l,e.horizontalHeld,e.verticalHeld,e,t,n)}),document.addEventListener("keyup",r=>{let o=r.key.toLowerCase(),a=r.key==="ArrowLeft"||o==="a",i=r.key==="ArrowRight"||o==="d",s=r.key==="ArrowUp"||o==="w",u=r.key==="ArrowDown"||o==="s",c=e.horizontalHeld,l=e.verticalHeld;if(a&&e.horizontalHeld==="left")e.horizontalHeld=null;else if(i&&e.horizontalHeld==="right")e.horizontalHeld=null;else if(s&&e.verticalHeld==="up")e.verticalHeld=null;else if(u&&e.verticalHeld==="down")e.verticalHeld=null;else return;R(c,l,e.horizontalHeld,e.verticalHeld,e,t,n)})}var Ze=30;function Ne(e,t){let n=e.bunny.animation;if(n.kind!=="hop")return;let r=n.direction==="toward"?-Ze:Ze,o=De(e.camera.z+r*t,e.depthBounds.minZ,e.depthBounds.maxZ);e.camera={...e.camera,z:o}}var jt=120;function Oe(e,t){let n=e.bunny.animation;if(!(n.kind==="hop"||n.kind==="walk"||n.kind==="jump")||e.horizontalHeld===null)return;let o=e.horizontalHeld==="left"?-1:1;e.camera={...e.camera,x:e.camera.x+jt*t*o}}var Wt={deadzone:20,tapThreshold:200,tapMaxDistance:15};function Pt(){return{joystick:null,currentDirection:null}}function Bt(e,t){let n=e.currentX-e.anchorX,r=e.currentY-e.anchorY;if(Math.sqrt(n*n+r*r)<t.deadzone)return null;let i=(Math.atan2(-r,n)*180/Math.PI+360)%360;return i>=337.5||i<22.5?"right":i>=22.5&&i<67.5?"up-right":i>=67.5&&i<112.5?"up":i>=112.5&&i<157.5?"up-left":i>=157.5&&i<202.5?"left":i>=202.5&&i<247.5?"down-left":i>=247.5&&i<292.5?"down":"down-right"}function Xe(e){return e===null?null:e.includes("left")?"left":e.includes("right")?"right":null}function Ye(e){return e===null?null:e.includes("up")?"up":e.includes("down")?"down":null}function Zt(e,t,n){let r=t-e.startTime,o=e.currentX-e.anchorX,a=e.currentY-e.anchorY,i=Math.sqrt(o*o+a*a);return r<n.tapThreshold&&i<n.tapMaxDistance}function $t(e,t,n,r,o,a){let i=Xe(e),s=Ye(e),u=Xe(t),c=Ye(t);r.horizontalHeld=u,r.verticalHeld=c,R(i,s,u,c,r,o,a),n.currentDirection=t}function Nt(e,t,n,r,o,a){if(e.joystick!==null){if(Zt(e.joystick,o,a))!T(t.bunny)&&!j(t.bunny)&&!L(t.bunny)&&W(t.bunny,n,r);else{let i=t.horizontalHeld,s=t.verticalHeld;t.horizontalHeld=null,t.verticalHeld=null,R(i,s,null,null,t,n,r)}e.joystick=null,e.currentDirection=null}}function Ue(e,t){for(let n of e)if(n.identifier===t)return n}function Ot(e,t){return Ue(e,t)!==void 0}function Xt(e,t,n){if(e.joystick!==null)return!1;let r=t[0];return r===void 0?!1:(e.joystick={anchorX:r.clientX,anchorY:r.clientY,currentX:r.clientX,currentY:r.clientY,startTime:n,identifier:r.identifier},!0)}function Yt(e,t,n,r,o,a){if(e.joystick===null)return!1;let i=Ue(o,e.joystick.identifier);if(i===void 0)return!1;let s=e.currentDirection;e.joystick.currentX=i.clientX,e.joystick.currentY=i.clientY;let u=Bt(e.joystick,a);return u!==s&&$t(s,u,e,t,n,r),!0}function Ut(e,t,n,r,o,a,i){if(e.joystick===null)return;Ot(o,e.joystick.identifier)||Nt(e,t,n,r,a,i)}function Ve(e,t,n,r=Wt){let o=Pt();document.addEventListener("touchstart",i=>{Xt(o,i.touches,Date.now())}),document.addEventListener("touchmove",i=>{Yt(o,e,t,n,i.touches,r)&&i.preventDefault()},{passive:!1});let a=i=>{Ut(o,e,t,n,i.touches,Date.now(),r)};return document.addEventListener("touchend",a),document.addEventListener("touchcancel",a),o}function D(e){return 50+e*5}function Ke(e){let t=new Map;for(let n of e)t.set(n,[]);return{sprites:t}}function F(e,t){let n=e.sprites.get(t);if(n!==void 0)return n;let r=[];return e.sprites.set(t,r),r}function se(e,t){let n=0;for(let r=0;r<e.length;r++){let o=e[r];if(o!==void 0&&o.width<t.width)n=r+1;else break}e.splice(n,0,t)}function qe(e,t){let n=[];for(let r of t){let o=e.sprites[r];if(o===void 0)continue;let a=o.widths;if(a!==void 0)for(let i of a)n.push({spriteName:r,width:i})}return n.sort((r,o)=>r.width-o.width),n}function Ge(e){let t=[];for(let n of e.layers)if(n.sprites!==void 0)for(let r of n.sprites)r.includes("grass")&&t.push(r);return t}function Je(e){return e.autoLayers===void 0?[]:e.autoLayers.sprites}function ce(e,t){let n=e.sprites[t];return n===void 0?[]:n.widths??[]}function Qe(e,t,n){let r=[];for(let o of e){let a=[];for(let i of o.spriteNames){let s=F(t,i),u=D(o.layer),c=100;if(o.tile){let l=n*4,d=n+l,f=Math.ceil(d/c)+1,m=-l/2;for(let p=0;p<f;p++){let h=m+p*c,y=H(i,s,h,u,0);a.push(y)}}else if(o.positions.length>0)for(let l of o.positions){let d=H(i,s,l,u,0);a.push(d)}else{let l=Math.floor(n/2),d=H(i,s,l,u,0);a.push(d)}}r.push({config:o,entities:a})}return r}var{validateSpriteModule:Vt}=G,nt=Date.now(),et=new Map;async function rt(e){let t=et.get(e);if(t!==void 0)return t;let n=(async()=>{let o=await import(`${e}?v=${String(nt)}`);return Vt(o,e)})();return et.set(e,n),n}async function Z(e,t,n,r){let o=r!==void 0?`_${r}`:"",a=`../dist/sprites/${e}/${t}/w${String(n)}${o}.js`,i=await rt(a);return{width:n,frames:i.frames}}async function ue(e,t){let n=`../dist/sprites/${e}/w${String(t)}.js`,r=await rt(n);return{width:t,frames:r.frames}}async function le(){let{validateConfig:e}=G,n=await(await fetch(`./config.json?v=${String(nt)}`)).json();return e(n)}async function S(e,t){let[n,r]=await Promise.all([Z("bunny",e,t,"left"),Z("bunny",e,t,"right")]);return{left:n.frames,right:r.frames}}async function tt(e,t){return(await Z("bunny",e,t)).frames}async function ot(e){let[t,n,r,o,a,i,s,u]=await Promise.all([S("walk",50),S("jump",50),S("idle",40),S("walk_to_idle",40),S("walk_to_turn_away",40),S("walk_to_turn_toward",40),tt("hop_away",40),tt("hop_toward",40)]);return{walkLeft:t.left,walkRight:t.right,jumpLeft:n.left,jumpRight:n.right,idleLeft:r.left,idleRight:r.right,walkToIdleLeft:o.left,walkToIdleRight:o.right,walkToTurnAwayLeft:a.left,walkToTurnAwayRight:a.right,walkToTurnTowardLeft:i.left,walkToTurnTowardRight:i.right,hopAway:s,hopToward:u}}async function it(e,t,n){let r=Ge(e),o=0,a=0;for(let i of r){let s=ce(e,i);a+=s.length}for(let i of r){let s=ce(e,i),u=F(t,i);for(let c of s){o++,n({phase:"grass",current:o,total:a,spriteName:i,width:c});let l=await ue(i,c);se(u,l)}}}async function at(e,t,n){let r=Je(e),o=qe(e,r),a=o.length;for(let i=0;i<o.length;i++){let s=o[i];if(s===void 0)continue;let{spriteName:u,width:c}=s;n({phase:"trees",current:i+1,total:a,spriteName:u,width:c});let l=F(t,u),d=await ue(u,c);se(l,d)}}async function fe(e,t,n,r){n({phase:"ground",current:1,total:1,spriteName:"ground",width:0}),await it(e,t,n),n({phase:"bunny",current:1,total:1,spriteName:"bunny",width:50});let o=await ot(e);r(o),await at(e,t,n)}function Kt(){return{getScreenElement:()=>document.getElementById("screen"),loadConfigFn:le,runProgressiveLoadFn:fe,requestAnimationFrameFn:e=>requestAnimationFrame(e),audioDeps:z()}}function qt(e){let t=new Set;for(let n of e.layers)if(n.sprites!==void 0)for(let r of n.sprites)t.add(r);if(e.autoLayers!==void 0)for(let n of e.autoLayers.sprites)t.add(n);return[...t]}async function de(e=Kt()){let t=await e.loadConfigFn(),n=e.getScreenElement();if(n===null)throw new Error("Screen element not found");let r=n,o=N(r);if(t.autoLayers===void 0)throw new Error("config.autoLayers is required for depth movement");let a=qt(t),i=Ke(a),s=te(t.layers,t.autoLayers),u=Qe(s,i,o.width),c=ve(),l=Ie(),d=D(t.autoLayers.minLayer),f=D(t.autoLayers.maxLayer),m=Ee(d,f,l),p=J(u,c,m),h=Le(),y=null,w={bunny:h,viewport:o,camera:c,depthBounds:m,horizontalHeld:null,verticalHeld:null,scene:p};window.addEventListener("resize",()=>{w.viewport=N(r)});let C=K(t.audio,e.audioDeps);C!==null&&V(()=>C.getSystem(),(g,I)=>{document.addEventListener(g,I)});let $=ze(p);x(400,$).start();let pe=t.settings.scrollSpeed,_=0;function me(g){let I=_>0?(g-_)/1e3:0;y!==null&&(Ne(w,I),Oe(w,I)),w.scene.camera=w.camera;let k={bunnyState:h,sceneState:w.scene,viewport:w.viewport,lastTime:_,projectionConfig:l};y!==null?_=ie(k,y,r,g,pe).lastTime:_=ie(k,Gt(),r,g,pe).lastTime,w.camera=w.scene.camera,e.requestAnimationFrameFn(me)}e.requestAnimationFrameFn(me),await e.runProgressiveLoadFn(t,i,g=>{},g=>{y=g;let k=Se(h,y,{walk:120,idle:500,jump:58,transition:50,hop:150},()=>w.horizontalHeld!==null);$e(w,y,k),Ve(w,y,k),k.walk.start(),k.idle.start()})}function Gt(){let e=[];return{walkLeft:e,walkRight:e,jumpLeft:e,jumpRight:e,idleLeft:e,idleRight:e,walkToIdleLeft:e,walkToIdleRight:e,walkToTurnAwayLeft:e,walkToTurnAwayRight:e,walkToTurnTowardLeft:e,walkToTurnTowardRight:e,hopAway:e,hopToward:e}}function Jt(){return import.meta.env?.MODE==="test"}!Jt()&&typeof document<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{de().catch(e=>{console.error("Failed to initialize:",e)})}):de().catch(e=>{console.error("Failed to initialize:",e)}));
